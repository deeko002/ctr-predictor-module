# CTR Predictor Module 

**Goal**: Predict the click-through rate (CTR) of an ad impression based on input features using a trained LightGBM model. This module takes a SQL query (generated by NLP) and produces CTR predictions for each resulting row.

---

## What This Module Does

```
User Query (via NLP)
    ↓
SQL Query (Step 2 output)
    ↓
Run query on avazu_df (DuckDB)
    ↓
Convert rows to model-ready features (feature_creator.py)
    ↓
Predict CTRs using LightGBM (predict_ctr.py)
    ↓
Return original + predicted_ctr
```

---

## Folder Structure

```
ctr-predictor-module/
├── train.csv                       # Avazu dataset (first 1M rows used)
├── feature_creator.py             # Converts raw input to model-ready features
├── predict_ctr.py                 # Loads trained LightGBM model and predicts CTR
├── main_pipeline.py               # Runs full SQL → prediction pipeline
├── test_main_pipeline.py          # Test script with sample SQL query
├── train_avazu_model.py           # (Optional) Retrain model using Avazu data
├── model/
│   └── ctr_model.txt              # Trained LightGBM model
├── utils/
│   └── ctr_encoding_map.json      # CTR encoding values for features
├── tests/
│   └── test_predict.py            # Unit test for prediction
├── README.md                      # You're here :)
```

---

## How To Run the Pipeline

1. **Install requirements** (if not already):
```bash
pip install pandas lightgbm duckdb scikit-learn
```

2. **Run the test query pipeline:**
```bash
python test_main_pipeline.py
```

This runs a full end-to-end pipeline:
- SQL → Feature creation → CTR prediction

---

## How To Customize

- To try a different SQL query, open `test_main_pipeline.py` and change the SQL string.
- To retrain the model on full Avazu:
  - Unzip full `train.csv`
  - Run:
    ```bash
    python train_avazu_model.py
    ```
  - This will update:
    - `model/ctr_model.txt`
    - `utils/ctr_encoding_map.json`

---

## How It Works Under the Hood

- `feature_creator.py`: Adds time features, CTR encodings, hashed interactions. Handles missing fields using fallback defaults.
- `predict_ctr.py`: Loads trained LightGBM model and makes predictions using selected numeric features.
- `main_pipeline.py`: Takes a SQL query string, runs it on Avazu subset, and returns predicted CTRs for the matching rows.
- `test_main_pipeline.py`: Example test script simulating NLP input.

---

## Team Notes

- You can call `run_sql_to_ctr_predictions(sql_query)` from any upstream component (e.g. UI, NLP handler, etc.)
- You can easily plug this into a dashboard or log predictions into DuckDB.
- This module is designed to be robust, modular, and compatible with your NLP → SQL → Prediction pipeline.

---
